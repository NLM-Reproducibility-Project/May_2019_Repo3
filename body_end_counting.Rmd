---
title: "Count body and end signal for the various samples and tracks"
author: "Manfred Schmid"
date: "9 August 2017"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'Figures_body_end_counting/', dev='pdf')
```

```{r, message=FALSE,warning=FALSE}
suppressWarnings(library('tidyverse'))
suppressWarnings(library('magrittr'))
suppressWarnings(library('knitr'))
```


# Create body and end annotations

Define gene body region: TSS to TES-200bp
Define gene end region: TES+/-200bp


Annotations used are the classical Steinmetz transcription unit annotations lifted to UCSC release *sacCer3*.

Body and ends are derived using awk and bedtools
```{bash, eval=FALSE}
#!/bin/bash

## for raw data

########################################################################################################################
####    ANNOTATIONS FOR BODY vs END
########################################################################################################################


# annotations for body and end counts
bed="/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin.bed"
awk '{OFS="\t"}{if($6=="+"){$3-=200;if(($3-$2)>100) print $0}}' $bed | cut -f1-4 > ${bed/.bed/_body_endsm200_plus.bed}
awk '{OFS="\t"}{if($6=="-"){$2+=200;if(($3-$2)>100) print $0}}' $bed | cut -f1-4 > ${bed/.bed/_body_endsm200_minus.bed}
awk '{OFS="\t"}{if($6=="+"){$2=$3-200;$3+=200; print $0}}' $bed | cut -f1-4 > ${bed/.bed/_ends_pm200_plus.bed}
awk '{OFS="\t"}{if($6=="-"){$3=$2+200;$2-=200; print $0}}' $bed | cut -f1-4 > ${bed/.bed/_ends_pm200_minus.bed}


head -3 $bed
#chrI    5076    6237    ST3634  SUT432  -       SUTs    SUT432
#chrI    7277    9261    ST3635  YAL067C -       ORF-T   SEO1
#chrI    9369    9601    ST0001  SUT001  +       SUTs    SUT001

head -3 ${bed/.bed/_body_endsm200_plus.bed}
#chrI    30073   30705   ST0002
#chrI    31153   32785   ST0003
#chrI    33361   34697   ST0004

head -3 ${bed/.bed/_body_endsm200_minus.bed}
#chrI    5276    6237    ST3634
#chrI    7477    9261    ST3635
#chrI    10933   11141   ST3636

head -3 ${bed/.bed/_ends_pm200_plus.bed}
#chrI    9401    9801    ST0001
#chrI    30705   31105   ST0002
#chrI    32785   33185   ST0003

head -3 ${bed/.bed/_ends_pm200_minus.bed}
#chrI    4876    5276    ST3634
#chrI    7077    7477    ST3635
#chrI    10533   10933   ST3636



##inspect the overlaps
bedtools intersect -wo -a ${bed/.bed/_body_endsm200_plus.bed} -b ${bed/.bed/_ends_pm200_plus.bed} > body_vs_end_intersect_plus.txt
bedtools intersect -wo -a ${bed/.bed/_body_endsm200_minus.bed} -b ${bed/.bed/_ends_pm200_minus.bed} > body_vs_end_intersect_minus.txt

head body_vs_end_intersect_plus.txt
#chrI    36545   37129   ST0006  chrI    36193   36593   ST0005  48
#chrI    37409   38833   ST0007  chrI    37129   37529   ST0006  120
#chrI    39217   41769   ST0008  chrI    38833   39233   ST0007  16
#chrI    42161   42633   ST0009  chrI    41769   42169   ST0008  8
#chrI    62791   65407   ST0015  chrI    62447   62847   ST0014  56
#chrI    79695   80447   ST0020  chrI    79335   79735   ST0019  40
#chrI    94607   95343   ST0024  chrI    94287   94687   ST0023  80
#chrI    130703  131887  ST0029  chrI    130367  130767  ST0028  64
#chrI    132199  133911  ST0030  chrI    131887  132287  ST0029  88
#chrI    136863  137439  ST0032  chrI    136503  136903  ST0031  40

wc -l body_vs_end_intersect_plus.txt
#970 body_vs_end_intersect_plus.txt

head body_vs_end_intersect_minus.txt
#chrI    33277   34381   ST3640  chrI    34181   34581   ST3641  200
#chrI    42941   43549   ST3643  chrI    43349   43749   ST3644  200
#chrI    51939   52659   ST3645  chrI    52459   52859   ST3646  200
#chrI    52859   54843   ST3646  chrI    54755   55155   ST3647  88
#chrI    55155   56923   ST3647  chrI    56723   57123   ST3648  200
#chrI    58075   58483   ST3649  chrI    58411   58811   ST3650  72
#chrI    65667   67851   ST3651  chrI    67651   68051   ST3652  200
#chrI    101683  105987  ST3661  chrI    105963  106363  ST3662  24
#chrI    106363  108667  ST3662  chrI    108659  109059  ST3663  8
#chrI    109059  110467  ST3663  chrI    110419  110819  ST3664  48

wc -l body_vs_end_intersect_minus.txt
#1050 body_vs_end_intersect_minus.txt

wc -l ${bed/.bed/_body_endsm200_plus.bed}
#    3381 /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_plus.bed
wc -l ${bed/.bed/_body_endsm200_minus.bed}
#    3385 /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_minus.bed

##roughly 1/3 of all body regions have overlapping end regions!




##filter out ends_pm200 from body annotations
bedtools subtract -a ${bed/.bed/_body_endsm200_plus.bed} -b ${bed/.bed/_ends_pm200_plus.bed} > ${bed/.bed/_body_endsm200_cleaned_plus.bed}
bedtools subtract -a ${bed/.bed/_body_endsm200_minus.bed} -b ${bed/.bed/_ends_pm200_minus.bed} > ${bed/.bed/_body_endsm200_cleaned_minus.bed}

#sanity check
##plus strand for ST0006 overlaps with extended end of ST0005
##body:
grep ST0006 ${bed/.bed/_body_endsm200_plus.bed}
#chrI    36545   37129   ST0006
##ends:
grep ST0005 ${bed/.bed/_ends_pm200_plus.bed}
#chrI    36193   36593   ST0005
##cleaned_body:
grep ST0006 ${bed/.bed/_body_endsm200_cleaned_plus.bed}
#chrI    36593   37129   ST0006



##minus strand for ST3640
##body:
#chrI    33277   34381   ST3640
##ends:
#chrI    32877   33277   ST3640
#chrI    34181   34581   ST3641
##cleaned_body:
#chrI    33277   34181   ST3640



wc -l ${bed/.bed/_body_endsm200_cleaned_plus.bed}
#    3359 /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_cleaned_plus.bed
wc -l ${bed/.bed/_body_endsm200_cleaned_minus.bed}
#    3366 /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_cleaned_minus.bed
##lost some 40 body annotations completely

cat ${bed/.bed/_body_endsm200_plus.bed} | awk '{sum+=($3-$2)}END{print sum}'
#4741689
cat ${bed/.bed/_body_endsm200_cleaned_plus.bed} | awk '{sum+=($3-$2)}END{print sum}'
#4629616
cat ${bed/.bed/_body_endsm200_minus.bed} | awk '{sum+=($3-$2)}END{print sum}'
#4717054
cat ${bed/.bed/_body_endsm200_cleaned_minus.bed} | awk '{sum+=($3-$2)}END{print sum}'
#4592248
##lost taken some 200000 bp of body annotations by this overlap cleaning


##how many body regions are "split apart" ?
cat /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_cleaned_plus.bed | cut -f 4 | uniq -c | grep -v "  1"
##no output, ie 0
cat /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_cleaned_minus.bed | cut -f 4 | uniq -c | grep -v "  1"
##no output ie 0
### this may at least have happened some times
### explanation is the Steinmetz annotations are NEVER overlapping on the same strand...


body_plus_bed=${bed/.bed/_body_endsm200_cleaned_plus.bed}
body_minus_bed=${bed/.bed/_body_endsm200_cleaned_minus.bed}
ends_plus_bed=${bed/.bed/_ends_pm200_plus.bed}
ends_minus_bed=${bed/.bed/_ends_pm200_minus.bed}

#final sort for later use
sort -k1,1 -k2,2n ${body_plus_bed} -o ${body_plus_bed}
sort -k1,1 -k2,2n ${body_minus_bed} -o ${body_minus_bed}
sort -k1,1 -k2,2n ${ends_plus_bed} -o ${ends_plus_bed}
sort -k1,1 -k2,2n ${ends_minus_bed} -o ${ends_minus_bed}
```



### body size taking genomic pA mask into account
```{bash, eval = FALSE}
body_plus_bed=${bed/.bed/_body_endsm200_cleaned_plus.bed}
body_minus_bed=${bed/.bed/_body_endsm200_cleaned_minus.bed}
ends_plus_bed=${bed/.bed/_ends_pm200_plus.bed}
ends_minus_bed=${bed/.bed/_ends_pm200_minus.bed}

## effective gene body region size using cleaned body annotations of pA filtered tracks...
pA_sites_plus="/Users/schmidm/Documents/Results/Lexogen_RNAseq/bams/sacCer3_flagged_KevinRoy_plus.bed"
pA_sites_minus="/Users/schmidm/Documents/Results/Lexogen_RNAseq/bams/sacCer3_flagged_KevinRoy_minus.bed"
sort -k1,1 -k2,2n ${pA_sites_plus} -o ${pA_sites_plus}
sort -k1,1 -k2,2n ${pA_sites_minus} -o ${pA_sites_minus}

bedtools map -a ${body_plus_bed} -b ${pA_sites_plus} -c 2 -o count > ${body_plus_bed/_cleaned_plus.bed/_cleaned_plus_pAfilter.counts}
bedtools map -a ${body_minus_bed} -b ${pA_sites_minus} -c 2 -o count > ${body_minus_bed/_cleaned_minus.bed/_cleaned_minus_pAfilter.counts}

cat /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/*_pAfilter.counts > /Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/clean_body_pAfilter.counts
```



# counting

```{bash, eval=FALSE}
#### NORMALIZED to S.pombe input FILES

body_plus_bed="/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_cleaned_plus.bed"
body_minus_bed="/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_body_endsm200_cleaned_minus.bed"
ends_plus_bed="/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_ends_pm200_plus.bed"
ends_minus_bed="/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3_latin_ends_pm200_minus.bed"


# A-filtered bigwigs location
cd /Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bedgraph

for f in *input*_plus_KevinRoyAfiltered.bedgraph
  do
     echo "end reads counting"
     echo $f
     sort -k1,1 -k2,2n $f | \
     bedtools map -c 4 -o sum -a $ends_plus_bed -b - > plus_gene_endpm200.counts

     fminus="${f/_plus/_minus}"
     echo $fminus
     sort -k1,1 -k2,2n $fminus | \
     bedtools map -c 4 -o sum -a $ends_minus_bed -b - > minus_gene_endpm200.counts

     echo "body reads counting"
     sort -k1,1 -k2,2n $f | \
     bedtools map -c 4 -o sum -a $body_plus_bed -b - > plus_gene_body.counts

     echo $fminus
     sort -k1,1 -k2,2n $fminus | \
     bedtools map -c 4 -o sum -a $body_minus_bed -b - > minus_gene_body.counts

     echo "merging ends"
     cat plus_gene_endpm200.counts minus_gene_endpm200.counts > \
     bedtools_counts/${f/_plus_KevinRoyAfiltered.bedgraph/_endpm200_count_sum_per_anno.txt}

     echo "merging body"
     cat plus_gene_body.counts minus_gene_body.counts > \
     bedtools_counts/${f/_plus_KevinRoyAfiltered.bedgraph/_body_endsm200_cleaned_count_sum_per_anno.txt}

     rm plus_gene_endpm200.counts
     rm minus_gene_endpm200.counts
     rm plus_gene_body.counts
     rm minus_gene_body.counts
     echo "done"
  done


#### BGsub IP NORMALIZED to S.pombe FILES
for f in *ip*_plus_KevinRoyAfiltered_BGsub.bedgraph
  do
     echo "end reads counting"
     echo $f
     sort -k1,1 -k2,2n $f | \
     bedtools map -c 4 -o sum -a $ends_plus_bed -b - > plus_gene_endpm200.counts

     fminus="${f/_plus/_minus}"
     echo $fminus
     sort -k1,1 -k2,2n $fminus | \
     bedtools map -c 4 -o sum -a $ends_minus_bed -b - > minus_gene_endpm200.counts

     echo "body reads counting"
     sort -k1,1 -k2,2n $f | \
     bedtools map -c 4 -o sum -a $body_plus_bed -b - > plus_gene_body.counts

     echo $fminus
     sort -k1,1 -k2,2n $fminus | \
     bedtools map -c 4 -o sum -a $body_minus_bed -b - > minus_gene_body.counts

     echo "merging ends"
     cat plus_gene_endpm200.counts minus_gene_endpm200.counts > \
     bedtools_counts/${f/_plus_KevinRoyAfiltered_BGsub.bedgraph/_BGsub_endpm200_count_sum_per_anno.txt}

     echo "merging body"
     cat plus_gene_body.counts minus_gene_body.counts > \
     bedtools_counts/${f/_plus_KevinRoyAfiltered_BGsub.bedgraph/_BGsub_body_endsm200_cleaned_count_sum_per_anno.txt}

     rm plus_gene_endpm200.counts
     rm minus_gene_endpm200.counts
     rm plus_gene_body.counts
     rm minus_gene_body.counts
     echo "done"
  done
```



# Load counts into R


```{r}
read_bedgraph_sums <- function(path, file_list, sfx) {
  lapply(file_list, function(fname) {read.table(paste0(path,fname,sep=''), header=F, col.names=c('chr', 'start', 'end', 'id', 'sum'), stringsAsFactors = FALSE) %>% 
      tbl_df %>%
  mutate(condition = sub(sfx, '', fname),
         condition = sub('norm_', '', condition),
         sum = ifelse(sum == '.', 0, as.numeric(sum)))}) %>%
  bind_rows()
}
```


#### load and combine end counts
```{r}
path <- '/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bedgraph/bedtools_counts/'
sfx <- '_endpm200_count_sum_per_anno.txt$'

file_list <- dir(path)[grep(sfx, dir(path))]

file_list %<>% keep( (grepl('ip', .) & grepl('BGsub', .)) | grepl('input', .))

file_list
```


```{r, warning=FALSE}
(end_counts_df <- read_bedgraph_sums(path, file_list, sfx))
```


#### load and combine body counts
```{r}
sfx <- '_body_endsm200_cleaned_count_sum_per_anno.txt$'

file_list <- dir(path)[grep(sfx, dir(path))]

file_list %<>% keep( (grepl('ip', .) & grepl('BGsub', .)) | grepl('input', .))

file_list
```

```{r, warning=FALSE}
(body_counts_df <- read_bedgraph_sums(path, file_list, sfx))
```


#### combine body and end 

```{r}
(both_df <- bind_rows(mutate(body_counts_df, part = 'body'), 
                     mutate(end_counts_df, part = 'end')) %>%
   mutate(pA = case_when(grepl('^noPap', .$condition) ~ 'pA+', 
                         grepl('^xPappAminus', .$condition) ~ 'pA-',
                         TRUE ~ 'pA+ + pA-')))
```


## Normalize body reads to body length

Annotations for correction to body length …
```{r}
(anno <- read.table("/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/Steinmetz_annotations_sacCer3.bed", col.names = c('chr', 'start', 'end', 'id', 'name', 'strand', 'type', 'common_name')) %>%
  tbl_df %>% 
  mutate(type = ifelse(grepl('^snR', name), 'snRNA', as.character(type)),
         type = factor(type, levels=c('ORF-T', 'SUTs', 'CUTs', 'snRNA', 'other'))))
```

body regions stripped for overlapping ends and content of masked genomic pA in this region
```{r}
(effective_body_and_genomic_pA_counts <- read.table('/Users/schmidm/Documents/Results/Lexogen_RNAseq/anno/genomic_pA_per_cleaned_body.txt', col.names=c('chr', 'start', 'end', 'id', 'pAfilter_count'), stringsAsFactors = FALSE) %>%
   mutate(body_len = end-start,
          pAfiltered_cleaned_body_len = body_len - as.integer(pAfilter_count)) %>%
   dplyr::select(-chr,-start, -end) %>%
   tbl_df)
```


```{r}
(anno <- left_join(anno, effective_body_and_genomic_pA_counts))
```

…. note some regions are NA … ie there is no body, either completely overlapping with ends or otherwise the annotation is too short!!

```{r}
(both_df %<>% 
  dplyr::select(id, sum, part, pA, condition) %>%
  left_join(., anno) %>%
  mutate(scaled_reads = ifelse(part == 'body',
                               sum/pAfiltered_cleaned_body_len,
                               sum)) %>%
  dplyr::select(id, name, common_name, type, part, pA, condition, sum, scaled_reads))
```


#### look at some single genes

```{r}
filter(both_df,
       common_name == 'PMA1',
       grepl('_0_1', condition)) %>%
  kable
```

```{r}
filter(both_df,
       common_name == 'PGK1',
       grepl('_0_1', condition)) %>%
  kable
```


## save the counts
```{r}
save(both_df, file='data/norm_signal_body_end_pA+_pA-_BGsub.RData')
```

```{r}
sessionInfo()
```




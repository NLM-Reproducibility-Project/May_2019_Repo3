---
title: "Correlation body vs end"
author: "Manfred Schmid"
output: html_document
---
`r format(Sys.time(), "%d %B, %Y")`

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs_correlation_body_vs_end_v2/', dev='pdf',
                      echo=TRUE, warning=FALSE, message=FALSE)
```



```{r load packages, echo=T, warning=F, message=F}
suppressWarnings(library(tidyverse))
suppressWarnings(library(magrittr))
suppressWarnings(library(knitr))
suppressWarnings(library(broom))
suppressWarnings(library(LSD))
```


### load the 3' seq counts

-> from script body_end_counting.Rmd  
-> her we only look at length-normalized BGsub data
```{r}
load('data/norm_signal_body_end_pA+_pA-_BGsub.RData', verbose=TRUE)

both_df
```

```{r}
body_pAminus <- filter(both_df, part == 'body', pA == 'pA-') %>%
  dplyr::select(-part, -pA, -Pap, -sum) %>%
  dplyr::rename(scaled_body_pAminus = scaled_reads)
```

```{r}
end_pAplus <- filter(both_df, part == 'end', pA == 'pA+') %>%
  dplyr::select(-part, -pA, -Pap, -sum) %>%
  dplyr::rename(scaled_end_pAplus = scaled_reads)
```

```{r}
(body_end_df <- full_join(end_pAplus, body_pAminus))
```


### main scatter plot fun
```{r}
heatscatter_plot <- function(df,
                             use_strain = 'Mex67AA', 
                             use_fraction = 'ip', 
                             use_type = 'all',
                             use_rapa = 0, 
                             use_rep = 1,
                             cor=T, 
                             colpal = 'bl2gr2rd', 
                             ...) {
  sel_df <- df %>%
  filter(strain == use_strain, fraction == use_fraction, rapa == use_rapa, rep == use_rep)

  if ( use_type != 'all' ) {
    sel_df %<>% filter(type == use_type)
  }
  
heatscatter(log2(sel_df$scaled_end_pAplus), log2(sel_df$scaled_body_pAminus), xlab=paste0(use_strain, '_',use_fraction, '_',use_rapa, '_', use_rep),
            cor=cor, colpal=colpal,...)
}
```

```{r heatscatters vs Milligan CRAC}
heatscatter2x1 <- function(df, ...) {
  par(mfrow=c(2,1))
  heatscatter_plot(df, use_fraction = 'input', ...)
  abline(0,1)
  heatscatter_plot(df, use_fraction = 'ip', ...)
  abline(0,1)
  par(mfrow=c(1,1))
}
```



```{r heatscatters body pA- end pA+ }
heatscatter2x1(body_end_df, method='pearson')
```

```{r heatscatters body pA- end pA+ ORFs}
heatscatter2x1(body_end_df, use_type = 'ORF-T', method='pearson')
```


```{r heatscatters body pA- end pA+ CUTs}
heatscatter2x1(body_end_df, use_type = 'CUTs', method='pearson')
```

# Synthesis Efficiency = body vs end ratio
```{r}
(body_end_df %<>%
  mutate(SE = scaled_end_pAplus/scaled_body_pAminus,
         log2SE = log2(SE)))
```


```{r log2SE histogram per type}
body_end_df %>%
  filter(rapa == 0, rep == 1, type != 'other', type != 'snRNA') %>%
ggplot(., aes(x=log2SE)) +
  geom_histogram() +
  facet_grid(type~fraction+strain+rapa+rep, scales='free') +
  theme_bw()
```


# bottom vs top SE

```{r}
SE_ranks <- body_end_df %>%
  filter(rapa == 0, rep == 1, type != 'other', type != 'snRNA', fraction == 'ip') %>%
  group_by(type) %>%
  mutate(SE_rank = rank(log2SE, ties.method = 'random'),
         SE_rank_rev = rank(desc(log2SE), ties.method = 'random')) 
```

#### least produced genes

any:  
```{r}
SE_ranks %>%
  filter(SE_rank < 20, type == 'ORF-T', scaled_body_pAminus > 0) %>%
  kable
```

with significant coverage in gene body:  
```{r}
SE_ranks %>%
  filter(SE_rank < 200, type == 'ORF-T', scaled_body_pAminus > 0.1) %>%
  kable
```


#### most efficiently produced genes

any
```{r}
SE_ranks %>%
  filter(SE_rank_rev < 20) %>%
  kable
```


with body signal
```{r}
SE_ranks %>%
  filter(SE_rank_rev < 35, scaled_body_pAminus > 0) %>%
  kable
```


with body signal
```{r}
SE_ranks %>%
  filter(SE_rank_rev < 55, scaled_body_pAminus > 0, strain == 'Mex67AA', type == 'ORF-T') %>%
  kable
```


#### SE vs gene length

```{r}
(anno <- read.table("/Users/schmidm/Documents/genomewide_datasets/annotations/sacCer3/Steinmetz_sacCer3_latin.bed", col.names = c('chr', 'start', 'end', 'anno', 'pad', 'strand')) %>%
  tbl_df %>% 
   separate(anno, c('id', 'type', 'name', 'common_name'), sep=':') %>%
  mutate(type = ifelse(grepl('^snR', name), 'snRNA', as.character(type)),
         type = factor(type, levels=c('ORF-T', 'SUTs', 'CUTs', 'snRNA', 'other'))) %>%
   arrange(id))
```


```{r log2SE vs gene length all}
left_join(SE_ranks, anno) %>%
  mutate(gene_length = end-start) %>%
  ggplot(., aes(x=log10(gene_length), y=log2SE, color=type)) +
  geom_point(size=.2) +
  stat_smooth(method='lm') +
  facet_grid(fraction~strain+rapa+rep)
```

```{r log2SE vs gene length only ORFs}
left_join(SE_ranks, anno) %>%
  filter(type == 'ORF-T') %>%
  mutate(gene_length = end-start) %>%
  ggplot(., aes(x=gene_length, y=log2SE)) +
  geom_point(size=.2) +
  stat_smooth(method='lm') +
  facet_grid(fraction~strain+rapa+rep) +
  theme_bw()
```



#### SE extremes GO using goseq


```{r}
library('goseq')
library('TxDb.Scerevisiae.UCSC.sacCer3.sgdGene')
library('org.Sc.sgd.db')
supportedGeneIDs() %>%
  filter(db == 'sgdGene')
```

```{r}
all.sgd.ids <- keys(org.Sc.sgd.db, keytype = "ENTREZID")

all.sgd.gotable <- select(org.Sc.sgd.db, keys = all.sgd.ids, keytype = "ENTREZID", columns=c('ORF', 'COMMON', 'ALIAS', 'GO'))

gene2cat <- all.sgd.gotable$GO
names(gene2cat) <- all.sgd.gotable$ORF
```


Genes with highest log2SE
```{r}
orf_se_ranks <- SE_ranks %>% 
  filter(strain == 'Mex67AA', fraction == 'ip', rapa == '0', rep == 1, type == 'ORF-T') %>%
  mutate(SE_rank = rank(log2SE, ties.method = 'random'),
         SE_rank_rev = rank(dplyr::desc(log2SE), ties.method = 'random')) %>%
  dplyr::distinct(name, .keep_all=TRUE)

top200 <- filter(orf_se_ranks, SE_rank < 200)
bottom200 <- filter(orf_se_ranks, SE_rank_rev < 200)
```
  

```{r}
top200_genes=as.integer(orf_se_ranks$name %in% top200$name)
names(top200_genes) <- orf_se_ranks$name
```

```{r}
pwf=nullp(top200_genes, genome='sacCer3', id = "sgdGene", )

head(pwf)
```

```{r}
GO_wall_top=goseq(pwf,"sacCer3","sgdGene", gene2cat=all.sgd.gotable[,c('ORF', 'GO')])
```

```{r}
head(filter(GO_wall_top, ontology=='MF'), 20)
```

```{r}
head(filter(GO_wall_top, ontology=='BP'), 20)
```

```{r}
head(filter(GO_wall_top, ontology=='CC'), 20)
```



```{r}
bottom200 <- filter(orf_se_ranks, SE_rank_rev < 200)
```

  

```{r}
bottom200_genes=as.integer(orf_se_ranks$name %in% bottom200$name)
names(bottom200_genes) <- orf_se_ranks$name
```

```{r}
pwf=nullp(bottom200_genes, genome='sacCer3', id = "sgdGene", )

head(pwf)
```


```{r}
GO_wall_bottom=goseq(pwf,"sacCer3","sgdGene", gene2cat=all.sgd.gotable[,c('ORF', 'GO', 'ONTOLOGY')], test.cats="GO:BP")

head(filter(GO_wall_bottom, ontology == 'BP'), 20)
```


```{r}
head(filter(GO_wall_bottom, ontology=='MF'), 20)
```

```{r}
head(filter(GO_wall_bottom, ontology=='BP'), 20)
```

```{r}
head(filter(GO_wall_bottom, ontology=='CC'), 20)
```




## correlation matrix


# Correlation body and end

```{r}
wide_df <- both_df %>% 
  filter(rapa==0, scaled_reads > 0, pA == 'pA+' | pA == 'pA+ + pA-') %>%
  tidyr::unite(condition, c(part, pA, strain, fraction, rapa, rep), sep='_') %>% 
  dplyr::select(id, condition, scaled_reads) %>%
  spread(condition, scaled_reads)
```

```{r}
wide_mat <- wide_df %>%
  dplyr::select(-id) %>%
  as.matrix %>%
  t 
```

```{r eucldiian distance pAplus and pApluspluspAminus}
dist <- wide_mat %>%
  log2 %>%
  dist

hc <- hclust(dist, method = 'ward.D2')

plot(hc)
```

```{r}
cor_dist <- function(matrix, ...) {
  cor <- cor(t(matrix), ...)
  as.dist( (-.5*cor)+.5 )
}
```

```{r pearson distance pAplus and pApluspluspAminus}
dist <- wide_mat %>%
  log2 %>%
  cor_dist(., method='pearson', use='pairwise.complete')

hc <- hclust(dist, method = 'ward.D2')

pearson_hc_order <- hc$labels[hc$order]

plot(hc)
```

```{r spearman distance pAplus and pApluspluspAminus}
dist <- wide_mat %>%
  log2 %>%
  cor_dist(., method='spearman', use='pairwise.complete')

hc <- hclust(dist, method = 'ward.D2')

spearman_hc_order <- hc$labels[hc$order]

plot(hc)
```


```{r pearson correlation matrix pAplus and pApluspluspAminus}
cor_df <- wide_mat %>%
  t %>%
  log2 %>%
  na.omit %>%
  cor(., method='pearson', use='pairwise.complete') %>%
  as.data.frame() %>%
  rownames_to_column(var='study1') %>%
  gather(study2, cor, -study1)

cor_df %>%
  mutate(study1 = factor(study1, levels=pearson_hc_order),
         study2 = factor(study2, levels=pearson_hc_order)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='firebrick4', mid='#e5e5be', high='navyblue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```


```{r spearman correlation matrix pAplus and pApluspluspAminus}
cor_df <- wide_mat %>%
  t %>%
  log2 %>%
  na.omit %>%
  cor(., method='spearman', use='pairwise.complete') %>%
  as.data.frame() %>%
  rownames_to_column(var='study1') %>%
  gather(study2, cor, -study1)

cor_df %>%
  mutate(study1 = factor(study1, levels=spearman_hc_order),
         study2 = factor(study2, levels=spearman_hc_order)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='firebrick4', mid='#e5e5be', high='navyblue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```



```{r}
sessionInfo()
```


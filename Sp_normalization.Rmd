---
title: "Normalize to S.pombe spike-ins"
author: "Manfred Schmid"
output: html_document
---
`r format(Sys.time(), "%d %B, %Y")`


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Normalize to S.pombe spike-ins. 

First collect the counts for each Spombe transcript:
```{bash, eval = FALSE}
#!/usr/bin/env bash


### get S.pombe annotations for gene TSS to TES + 300bp
cd /Users/schmidm/Documents/genomewide_datasets/annotations/Spombe_ENSEMBL_EF2

#extract exons and convert to 0-based
cat Sp_genes.gtf | awk '{if($3=="exon"){sub("\"","",$12);sub("\";","",$12);print $1"\t"$4-1"\t"$5"\t"$12"\t"$3"\t"$7}}' > Sp_exons.bed

#combine exons of each annotation and extend end by 300bp after TES
awk '$6=="+"' Sp_exons.bed | sort -k4,4 -k2,2n | awk '{if($4==i){e=$3+300}else{print c"\t"s"\t"e"\t"i"\t"t"\t"str; c=$1;s=$2;e=$3+300;i=$4;t=$5;str=$6}}END{print c"\t"s"\t"e"\t"i"\t"t"\t"str}' | sed 1d | sort -k1,1 -k2,2n > Sp_exons_ends_p300_plus.bed

awk '$6=="-"' Sp_exons.bed | sort -k4,4 -k2,2n | awk '{if($4==i){e=$3}else{print c"\t"s"\t"e"\t"i"\t"t"\t"str; c=$1;s=$2-300;if(s < 0){s=0};e=$3;i=$4;t=$5;str=$6}}END{print c"\t"s"\t"e"\t"i"\t"t"\t"str}' | sed 1d | sort -k1,1 -k2,2n > Sp_exons_ends_p300_minus.bed

## count from raw bedgraphs
plus_bed="/Users/schmidm/Documents/genomewide_datasets/annotations/Spombe_ENSEMBL_EF2/Sp_exons_ends_p300_plus.bed"
minus_bed="/Users/schmidm/Documents/genomewide_datasets/annotations/Spombe_ENSEMBL_EF2/Sp_exons_ends_p300_minus.bed"

cd /Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/raw_bedgraph

mkdir Spombe_per_gene_counts

for b in *_plus.bedgraph
do

  echo "counting plus strand file ${b}"
  grep -v ^chr $b > Sp.plus
  bash /Users/schmidm/ms_tools/MS_Metagene_Tools/bed_count.sh $plus_bed Sp.plus 4 plus.sums

  echo "   minus strand"
  grep -v ^chr ${b/plus/minus} > Sp.minus
  bash /Users/schmidm/ms_tools/MS_Metagene_Tools/bed_count.sh $minus_bed Sp.minus 4 minus.sums

  cat plus.sums minus.sums | sort -k1,1 -k2,2n > Spombe_per_gene_counts/${b/_plus.bedgraph/_Sp.raw_counts}

  rm Sp.plus
  rm Sp.minus
  rm plus.sums
  rm minus.sums
done
```


#### DEseq2 for Spombe size factors

Next step --> feed these counts into DESeq2 and get the sizefactors.

```{r, message=FALSE}
suppressWarnings(library('tidyverse'))
suppressWarnings(library('magrittr'))
suppressWarnings(library('DESeq2'))
```


```{r}
path <- '/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/raw_bedgraph/Spombe_per_gene_counts/'

sfx <- '_Sp.raw_counts$'

file_list <- dir(path)[grep(sfx, dir(path))]

(Sp_counts_df <- lapply(file_list, function(fname) {read.table(paste0(path,fname,sep=''), col.names=c('chr', 'start', 'end', 'id', 'type', 'strand', 'count'), stringsAsFactors = FALSE) %>% 
    tbl_df %>%
  mutate(condition = sub(sfx, '', fname))}) %>%
  bind_rows() %>%
  mutate(count = ifelse(count == '.', 0, as.numeric(count))))
```



make count matrix
```{r}
Sp_count_mat <- Sp_counts_df %>% 
  dplyr::select(id,count,condition) %>%
  tidyr::spread(condition, count) %>%
  remove_rownames %>%
  data.frame %>%
  column_to_rownames(var='id') %>%
  as.matrix

head(Sp_count_mat)
```


make colData  
```{r}
Sp_coldata <- data.frame(condition = colnames(Sp_count_mat) ) %>%
  tidyr::separate(condition, c('Pap', 'strain', 'fraction', 'rapa', 'replicate'), by='_') %>%
  mutate(condition = paste0(Pap, '_', strain, '_', fraction, '_', rapa))

rownames(Sp_coldata) <- colnames(Sp_count_mat)

Sp_coldata
```


make DESeq object and get sizeFactors
```{r}
Sp_ddsFullCountTable <- DESeqDataSetFromMatrix(
countData = Sp_count_mat,
colData = Sp_coldata,
design = ~ condition)

Sp_genes_sf <- sizeFactors(estimateSizeFactors(Sp_ddsFullCountTable))

data.frame(Sp_genes_sf)
```

#### correct size factor for xPap_Nab2AA_ip_0_1 sample

note this was a mistake already realized during pipetting, ie only for sample xPap_Nab2AA_ip_0_1 was there used 3x more spike-in. This only affects xPap_Nab2AA_ip_0_1 as all other samples are mix of ip_0_2 and ip_0_3.

```{r}
Sp_genes_sf['xPap_Nab2AA_ip_0_1'] <- Sp_genes_sf['xPap_Nab2AA_ip_0_1']/3

data.frame(Sp_genes_sf)
```



```{r}
write.table(Sp_genes_sf, file='data/Sp_genes_sf.txt', col.names=F, quote=F)
```


## use size factors for normalizing track files

```{bash, eval=FALSE}
#!/bin/bash

cd /Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/KevinRoyAfiltered_bedgraph

cat ../../Rproject/data/Sp_genes_sf.txt | \
while read sf
  do
    sf_map=(${sf/ / })
    bdgp="${sf_map[0]}_plus_KevinRoyAfiltered.bedgraph"
    echo "doing ${bdgp}"
    echo "  sf: ${sf}"
    awk -v sf="${sf_map[1]}" '{OFS="\t"}{$4/=sf; print $0}' ${bdgp} > "norm_"${bdgp}

    bdgp="${sf_map[0]}_minus_KevinRoyAfiltered.bedgraph"
    echo "doing ${bdgp}"
    awk -v sf="${sf_map[1]}" '{OFS="\t"}{$4/=sf; print $0}' ${bdgp} > "norm_"${bdgp}
  done

mkdir ../norm_and_pA_filtered_bedgraph
mv norm*.bedgraph ../norm_and_pA_filtered_bedgraph/.
```


```{bash, eval=FALSE}
##  sanity check
cd /Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bedgraph

rm tmp
for f in *.bedgraph
  do
    echo $f >> tmp
    awk '{sum+=$4}END{print sum}' $f >> tmp
  done

cat tmp | paste - - > total_reads_after_norm.txt
rm tmp

cat total_reads_after_norm.txt
#norm_noPap_Mex67AA_input_0_1_minus_KevinRoyAfiltered.bedgraph   2.43941e+06
#norm_noPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bedgraph    2.56162e+06
#norm_noPap_Mex67AA_input_15_1_minus_KevinRoyAfiltered.bedgraph  1.99497e+06
#norm_noPap_Mex67AA_input_15_1_plus_KevinRoyAfiltered.bedgraph   2.02347e+06
#norm_noPap_Mex67AA_input_70_1_minus_KevinRoyAfiltered.bedgraph  1.65808e+06
#norm_noPap_Mex67AA_input_70_1_plus_KevinRoyAfiltered.bedgraph   1.70872e+06
#norm_noPap_Mex67AA_ip_0_1_minus_KevinRoyAfiltered.bedgraph      249138
#norm_noPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered.bedgraph       259009
#norm_noPap_Mex67AA_ip_15_1_minus_KevinRoyAfiltered.bedgraph     158750
#norm_noPap_Mex67AA_ip_15_1_plus_KevinRoyAfiltered.bedgraph      162368
#norm_noPap_Mex67AA_ip_70_1_minus_KevinRoyAfiltered.bedgraph     119750
#norm_noPap_Mex67AA_ip_70_1_plus_KevinRoyAfiltered.bedgraph      121059
#norm_noPap_Mex67AA_ip_neg0_1_minus_KevinRoyAfiltered.bedgraph   171477
#norm_noPap_Mex67AA_ip_neg0_1_plus_KevinRoyAfiltered.bedgraph    181896
#norm_noPap_Nab2AA_input_0_1_minus_KevinRoyAfiltered.bedgraph    2.57709e+06
#norm_noPap_Nab2AA_input_0_1_plus_KevinRoyAfiltered.bedgraph     2.69421e+06
#norm_noPap_Nab2AA_input_15_1_minus_KevinRoyAfiltered.bedgraph   2.08369e+06
#norm_noPap_Nab2AA_input_15_1_plus_KevinRoyAfiltered.bedgraph    2.07446e+06
#norm_noPap_Nab2AA_ip_0_1_minus_KevinRoyAfiltered.bedgraph       210919
#norm_noPap_Nab2AA_ip_0_1_plus_KevinRoyAfiltered.bedgraph        219016
#norm_noPap_Nab2AA_ip_15_1_minus_KevinRoyAfiltered.bedgraph      149783
#norm_noPap_Nab2AA_ip_15_1_plus_KevinRoyAfiltered.bedgraph       149829
#norm_xPap_Mex67AA_input_0_1_minus_KevinRoyAfiltered.bedgraph    8.235e+06
#norm_xPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bedgraph     8.6007e+06
#norm_xPap_Mex67AA_input_15_1_minus_KevinRoyAfiltered.bedgraph   8.08092e+06
#norm_xPap_Mex67AA_input_15_1_plus_KevinRoyAfiltered.bedgraph    9.26736e+06
#norm_xPap_Mex67AA_input_70_1_minus_KevinRoyAfiltered.bedgraph   6.36653e+06
#norm_xPap_Mex67AA_input_70_1_plus_KevinRoyAfiltered.bedgraph    8.38933e+06
#norm_xPap_Mex67AA_ip_0_1_minus_KevinRoyAfiltered.bedgraph       1.52247e+06
#norm_xPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered.bedgraph        1.68088e+06
#norm_xPap_Mex67AA_ip_0_2_minus_KevinRoyAfiltered.bedgraph       1.59387e+06
#norm_xPap_Mex67AA_ip_0_2_plus_KevinRoyAfiltered.bedgraph        1.77986e+06
#norm_xPap_Mex67AA_ip_0_3_minus_KevinRoyAfiltered.bedgraph       1.64485e+06
#norm_xPap_Mex67AA_ip_0_3_plus_KevinRoyAfiltered.bedgraph        1.82961e+06
#norm_xPap_Mex67AA_ip_15_1_minus_KevinRoyAfiltered.bedgraph      1.20696e+06
#norm_xPap_Mex67AA_ip_15_1_plus_KevinRoyAfiltered.bedgraph       1.4537e+06
#norm_xPap_Mex67AA_ip_15_2_minus_KevinRoyAfiltered.bedgraph      1.66334e+06
#norm_xPap_Mex67AA_ip_15_2_plus_KevinRoyAfiltered.bedgraph       1.91003e+06
#norm_xPap_Mex67AA_ip_15_3_minus_KevinRoyAfiltered.bedgraph      1.30827e+06
#norm_xPap_Mex67AA_ip_15_3_plus_KevinRoyAfiltered.bedgraph       1.51184e+06
#norm_xPap_Mex67AA_ip_70_1_minus_KevinRoyAfiltered.bedgraph      1.02159e+06
#norm_xPap_Mex67AA_ip_70_1_plus_KevinRoyAfiltered.bedgraph       1.15954e+06
#norm_xPap_Mex67AA_ip_70_2_minus_KevinRoyAfiltered.bedgraph      876941
#norm_xPap_Mex67AA_ip_70_2_plus_KevinRoyAfiltered.bedgraph       1.01189e+06
#norm_xPap_Mex67AA_ip_70_3_minus_KevinRoyAfiltered.bedgraph      972716
#norm_xPap_Mex67AA_ip_70_3_plus_KevinRoyAfiltered.bedgraph       1.09848e+06
#norm_xPap_Mex67AA_ip_neg0_1_minus_KevinRoyAfiltered.bedgraph    642529
#norm_xPap_Mex67AA_ip_neg0_1_plus_KevinRoyAfiltered.bedgraph     736931
#norm_xPap_Nab2AA_input_0_1_minus_KevinRoyAfiltered.bedgraph     7.75808e+06
#norm_xPap_Nab2AA_input_0_1_plus_KevinRoyAfiltered.bedgraph      8.42385e+06
#norm_xPap_Nab2AA_input_15_1_minus_KevinRoyAfiltered.bedgraph    8.61738e+06
#norm_xPap_Nab2AA_input_15_1_plus_KevinRoyAfiltered.bedgraph     9.12701e+06
#norm_xPap_Nab2AA_ip_0_1_minus_KevinRoyAfiltered.bedgraph        1.06561e+06
#norm_xPap_Nab2AA_ip_0_1_plus_KevinRoyAfiltered.bedgraph 1.15263e+06
#norm_xPap_Nab2AA_ip_0_2_minus_KevinRoyAfiltered.bedgraph        1.35616e+06
#norm_xPap_Nab2AA_ip_0_2_plus_KevinRoyAfiltered.bedgraph 1.47776e+06
#norm_xPap_Nab2AA_ip_0_3_minus_KevinRoyAfiltered.bedgraph        1.19444e+06
#norm_xPap_Nab2AA_ip_0_3_plus_KevinRoyAfiltered.bedgraph 1.3269e+06
#norm_xPap_Nab2AA_ip_15_1_minus_KevinRoyAfiltered.bedgraph       1.60304e+06
#norm_xPap_Nab2AA_ip_15_1_plus_KevinRoyAfiltered.bedgraph        1.85158e+06
#norm_xPap_Nab2AA_ip_15_2_minus_KevinRoyAfiltered.bedgraph       1.64883e+06
#norm_xPap_Nab2AA_ip_15_2_plus_KevinRoyAfiltered.bedgraph        1.8678e+06
#norm_xPap_Nab2AA_ip_15_3_minus_KevinRoyAfiltered.bedgraph       1.34873e+06
#norm_xPap_Nab2AA_ip_15_3_plus_KevinRoyAfiltered.bedgraph        1.5025e+06
```

--> similar samples have very similar read counts but between ie ip vs input and xPap vs noPap there are huge differences.



```{r}
sessionInfo()
```


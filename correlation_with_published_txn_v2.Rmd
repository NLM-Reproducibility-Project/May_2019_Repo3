---
title: "Correlation with published transcription studies"
author: "Manfred Schmid"
output: html_document
---
`r format(Sys.time(), "%d %B, %Y")`

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs_correlation_with_published_txn_v2/', dev='pdf',
                      echo=TRUE, warning=FALSE, message=FALSE)
```



```{r load packages, echo=T, warning=F, message=F}
suppressWarnings(library(tidyverse))
suppressWarnings(library(magrittr))
suppressWarnings(library(knitr))
suppressWarnings(library(broom))
suppressWarnings(library(LSD))
```


### load the transcription estimates

from Markdown *Published_txn_estimates_gene_body_counting.Rmd*
```{r}
load(file='data/published_gene_body_txn_estimates.RData', verbose=TRUE)

txn_estimates
```



### load the 3' seq counts

-> from script body_end_counting.Rmd  
-> her we only look at length-normalized BGsub data
```{r}
load('data/norm_signal_body_end_pA+_pA-_BGsub.RData', verbose=TRUE)

both_df
```


### combine and focus on 0 rapa samples
```{r}
(both_df %<>% filter(rapa == 0, scaled_reads > 0) %>% left_join(., txn_estimates))
```

### main scatter plot fun
```{r}
heatscatter_plot <- function(df,
                             y_col = 'rpb3_ChIPseq_mean',
                             use_part = 'body', 
                             use_pA = 'pA-', 
                             use_strain = 'Mex67AA', 
                             use_fraction = 'ip', 
                             use_rapa = 0, 
                             use_rep = 1,
                             cor=T, 
                             colpal = 'bl2gr2rd', 
                             ...) {
  sel_df <- df %>%
  filter(part == use_part, pA == use_pA, strain == use_strain, fraction == use_fraction, rapa == use_rapa, rep == use_rep)

heatscatter(log2(sel_df$scaled_reads), log2(unlist(sel_df[, y_col])), xlab=paste0(use_part, ' ',use_pA, ': ',use_strain, '_',use_fraction, '_',use_rapa, '_', use_rep), ylab = y_col,
            cor=cor, colpal=colpal,...)
}
```

```{r heatscatters vs Milligan CRAC}
heatscatter2x2 <- function(df, ycol = 'CRAC_mean_signal', ...) {
  par(mfrow=c(2,2))
  heatscatter_plot(df, y_col = ycol, use_fraction = 'input', ...)

  heatscatter_plot(df, y_col = ycol, use_fraction = 'ip', ...)

  heatscatter_plot(df, y_col = ycol, use_part = 'end', use_pA = 'pA+', use_fraction = 'input', ...)

  heatscatter_plot(df, y_col = ycol, use_part = 'end', use_pA = 'pA+', use_fraction = 'ip', ...)
  par(mfrow=c(1,1))
}
```



# overall correlations
```{r}
both_df %<>%
  group_by(part, pA, strain, fraction, rapa, rep)
```


#### with Rpb3 ChIP^2

Correlations
```{r}
both_df %>%
  summarise(cor_pearson_xmean = cor(scaled_reads, rpb3_chip2_mean, method='pearson'),
            cor_pearson_xmedian = cor(scaled_reads, rpb3_chip2_median, method='pearson'),
            cor_spearman_xmean = cor(scaled_reads, rpb3_chip2_mean, method='spearman'),
            cor_spearman_xmedian = cor(scaled_reads, rpb3_chip2_median, method='spearman')) %>%
  kable
```



```{r heatscatters body pA- end pA+ vs Rpb3 ChIP2 means}
heatscatter2x2(both_df, ycol = 'rpb3_chip2_mean', method='pearson')
```

```{r heatscatters body pA- end pA+ vs Rpb3 ChIP2 medians}
heatscatter2x2(both_df, ycol = 'rpb3_chip2_median', method='pearson')
```


#### with Rpb3 ChIPseq

Correlations
```{r}
both_df %>%
  summarise(cor_pearson_xmean = cor(scaled_reads, rpb3_ChIPseq_mean, method='pearson', use='pairwise.complete'),
            cor_pearson_xmedian = cor(scaled_reads, rpb3_ChIPseq_median, method='pearson', use='pairwise.complete'),
            cor_spearman_xmean = cor(scaled_reads, rpb3_ChIPseq_mean, method='spearman', use='pairwise.complete'),
            cor_spearman_xmedian = cor(scaled_reads, rpb3_ChIPseq_median, method='spearman', use='pairwise.complete')) %>%
  kable
```



```{r heatscatters body pA- end pA+ vs Rpb3 ChIPseq means}
heatscatter2x2(both_df, ycol = 'rpb3_ChIPseq_mean', method='pearson')
```

```{r heatscatters body pA- end pA+ vs Rpb3 ChIPseq medians}
heatscatter2x2(both_df, ycol = 'rpb3_ChIPseq_median', method='pearson')
```


#### with NETseq

Correlations
```{r}
both_df %>%
  summarise(cor_pearson_xmean = cor(scaled_reads, NETseq_mean_signal, method='pearson', use='pairwise.complete'),
            cor_spearman_xmean = cor(scaled_reads, NETseq_mean_signal, method='spearman', use='pairwise.complete')) %>%
  kable
```



```{r heatscatters body pA- end pA+ vs NETseq}
heatscatter2x2(both_df, ycol = 'NETseq_mean_signal', method='pearson')
```


#### with RNAPII density Pelechano

Correlations
```{r}
both_df %>%
  summarise(cor_pearson_xmean = cor(scaled_reads, RNAPII_density, method='pearson', use='pairwise.complete'),
            cor_spearman_xmean = cor(scaled_reads, RNAPII_density, method='spearman', use='pairwise.complete')) %>%
  kable
```



```{r heatscatters body pA- end pA+ vs Pelechano RNAPIIdensity}
heatscatter2x2(both_df, ycol = 'RNAPII_density', method='pearson')
```


#### with RNAPII CRAC Milligan

Correlations
```{r}
both_df %>%
  summarise(cor_pearson_xmean = cor(scaled_reads, CRAC_mean_signal, method='pearson', use='pairwise.complete'),
            cor_spearman_xmean = cor(scaled_reads, CRAC_mean_signal, method='spearman', use='pairwise.complete')) %>%
  kable
```



```{r heatscatters body pA- end pA+ vs CRAC}
heatscatter2x2(both_df, ycol = 'CRAC_mean_signal', method='pearson')
```



#### with Neugebauer nascent 3'seq


Correlations
```{r}
both_df %>%
  summarise(cor_pearson_xmean = cor(scaled_reads, nascent_3seq_mean, method='pearson', use='pairwise.complete'),
            cor_spearman_xmean = cor(scaled_reads, nascent_3seq_mean, method='spearman', use='pairwise.complete')) %>%
  kable
```



```{r heatscatters body pA- end pA+ vs Neugebauer nascent seq}
heatscatter2x2(both_df, ycol = 'nascent_3seq_mean', method='pearson')
```


# correlation matrices

```{r}
our_data <- both_df %>%
  unite(sample, c(part,pA,strain,fraction,rapa,rep), sep='_') %>%
  dplyr::select(id, sample, scaled_reads) %>%
  spread(sample, scaled_reads)

wide_df <- left_join(our_data, txn_estimates) 
```


#### Pearson correlation matrix

```{r}
study_order <- colnames(wide_df)[2:ncol(wide_df)]

study_order2 <- study_order[order(sub('Mex67', 'Nab2', study_order) %>%
                                    sub('CRAC', 'nCRAC', .))]
```

```{r}
pearson_cor_df <- wide_df %>%
  dplyr::select(-id) %>%
  as.matrix(.) %>%
  cor(., method='pearson', use='pairwise.complete.obs') %>%
  as.data.frame() %>%
  rownames_to_column(var='study1') %>%
  gather(study2, cor, -study1) %>%
  mutate(study1 = factor(study1, levels=study_order2),
         study2 = factor(study2, levels=study_order2))
```


```{r pearson correlation matrix all}
pearson_cor_df %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```


```{r pearson correlation matrix wo pAplusandminus}
pearson_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```

```{r pearson correlation matrix wo pAplus_ends pAminus_body}
pearson_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2),
         !grepl('body_pA\\+', study1), !grepl('body_pA\\+', study2),
         !grepl('end_pA\\-', study1), !grepl('end_pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```



```{r}
pearson_log_cor_df <- wide_df %>%
  dplyr::select(-id) %>%
  as.matrix(.) %>%
  log2 %>%
  na.omit() %>%
  cor(., method='pearson', use='pairwise.complete.obs') %>%
  as.data.frame() %>%
  rownames_to_column(var='study1') %>%
  gather(study2, cor, -study1) %>%
  mutate(study1 = factor(study1, levels=study_order2),
         study2 = factor(study2, levels=study_order2))
```


```{r pearson log correlation matrix all}
pearson_log_cor_df %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```


```{r pearson log correlation matrix wo pAplusandminus}
pearson_log_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```

```{r pearson log correlation matrix wo pAplus_ends pAminus_body}
pearson_log_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2),
         !grepl('body_pA\\+', study1), !grepl('body_pA\\+', study2),
         !grepl('end_pA\\-', study1), !grepl('end_pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```



#### Spearman correlation matrix
```{r}
spearman_cor_df <- wide_df %>%
  dplyr::select(-id) %>%
  as.matrix(.) %>%
  cor(., method='spearman', use='pairwise.complete') %>%
  as.data.frame() %>%
  rownames_to_column(var='study1') %>%
  gather(study2, cor, -study1) %>%
  mutate(study1 = factor(study1, levels=study_order2),
         study2 = factor(study2, levels=study_order2))
```


```{r spearman correlation matrix all}
spearman_cor_df %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```

```{r spearman correlation matrix wo pAplusandminus}
spearman_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```

```{r spearman correlation matrix wo pAplus_ends pAminus_body}
spearman_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2),
         !grepl('body_pA\\+', study1), !grepl('body_pA\\+', study2),
         !grepl('end_pA\\-', study1), !grepl('end_pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```


```{r}
spearman_log_cor_df <- wide_df %>%
  dplyr::select(-id) %>%
  as.matrix(.) %>%
  log2 %>%
  na.omit %>%
  cor(., method='spearman', use='pairwise.complete') %>%
  as.data.frame() %>%
  rownames_to_column(var='study1') %>%
  gather(study2, cor, -study1) %>%
  mutate(study1 = factor(study1, levels=study_order2),
         study2 = factor(study2, levels=study_order2))
```


```{r spearman log correlation matrix all}
spearman_log_cor_df %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```

```{r spearman log correlation matrix wo pAplusandminus}
spearman_log_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```

```{r spearman log correlation matrix wo pAplus_ends pAminus_body}
spearman_log_cor_df %>%
  filter(!grepl('pA\\+ \\+ pA\\-', study1),
         !grepl('pA\\+ \\+ pA\\-', study2),
         !grepl('body_pA\\+', study1), !grepl('body_pA\\+', study2),
         !grepl('end_pA\\-', study1), !grepl('end_pA\\-', study2)) %>%
  ggplot(.,aes(x=study1, y=study2, fill=cor)) + 
  geom_tile() +
  scale_fill_gradient2(low='red', mid='white', high='blue', limits=c(-1,1)) +
  theme(axis.text.x=element_text(angle=45, hjust=1, size = 6),
        axis.text.y=element_text(size = 6))
```


```{r}
sessionInfo()
```


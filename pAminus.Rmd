---
title: "Create pAminus Tracks by Subtraction"
author: "Manfred Schmid"
date: "9 August 2017"
output: html_document
---

```{r setup}
knitr::opts_chunk$set(echo = TRUE, fig.path = 'Figures_pAminus_tracks/', dev='pdf')
```

```{r, message=FALSE,warning=FALSE}
suppressWarnings(library('tidyverse'))
suppressWarnings(library('magrittr'))
```


# pAminus = pA++pA- minus pA+

Using S.pombe normalized values: subtract values from pA+ libraries from EPAP libraries  
ups:
--> can result in negatives!!  
--> for IPs this can result in pA- values higher than pA++pA- since pA+ can be negative

uses the *subtract_bedgraph.py* python script as in BGSub.Rmd


apply this to all files
```{bash, eval=FALSE}
#!/bin/bash

#This script substracts the values at each positions covered in ie the noPap libraries from xPap libraries

## subtract all noPap input positions for filtering from xPap ##

cd /Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bedgraph/

## input files, each xPap has exactly one matching noPap ...
for f in norm_xPap_*_input_*.bedgraph
  do
    echo $f
    python ~/ms_tools/MS_Metagene_Tools/subtract_bedgraph.py ${f} ${f/xPap/noPap} \
      --chunk_size 100000 --value_col 4 -o ${f/xPap_/xPappAminus_}
  done


## ip files, each noPap has 3 matching xPap files, ie the replicates
for f in norm_xPap_*_ip_*_KevinRoyAfiltered_BGsub.bedgraph
  do
    echo $f
    noPap_file=$(echo ${f/xPap/noPap} | sed s/_2_/_1_/g | sed s/_3_/_1_/g)
    echo ${noPap_file}
    python ~/ms_tools/MS_Metagene_Tools/subtract_bedgraph.py ${f} ${noPap_file} \
      --chunk_size 100000 --value_col 4 -o ${f/xPap_/xPappAminus_}
  done
```


#### get stats for the effect of pAminus vs pA+
```{bash, eval = FALSE}
#### total signals and positions above 0
echo "file sum_pAplus_signal sum_pAplusandminus_signal sum_pAminus_signal sum_pAplus_positions sum_pAplusandminus_positions sum_pAminus_positions" > pAminus.stats
for f in *xPappAminus*.bedgraph
    do
        echo $f
        both=$(awk '{sum += $4*($3-$2)}END{printf("%8.2f",sum)}' ${f/xPappAminus/xPap})
        pAminus=$(awk '{sum += $4*($3-$2)}END{printf("%8.2f",sum)}' $f)
        noPap_file=$(echo ${f/xPappAminus/noPap} | sed s/_2_/_1_/g | sed s/_3_/_1_/g)
        pAplus=$(awk '{sum += $4*($3-$2)}END{printf("%8.2f",sum)}' $noPap_file)

        both_pos=$(awk '{if($4 > 0){sum += ($3-$2)}}END{printf("%8.2f",sum)}' ${f/xPappAminus/xPap})
        pAminus_pos=$(awk '{if($4 > 0){sum += ($3-$2)}}END{printf("%8.2f",sum)}' $f)
        pAplus_pos=$(awk '{if($4 > 0){sum += ($3-$2)}}END{printf("%8.2f",sum)}' $noPap_file)
        echo "${f/.bedgraph/} $pAplus $both $pAminus $pAplus_pos $both_pos $pAminus_pos" >> pAminus.stats
    done
```

#### visualize those stats
```{r}
(stats <- read.table('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bedgraph/pAminus.stats', header=TRUE) %>% tbl_df %>%
  mutate(file = sub('^norm_', '', file) %>% 
           sub('_BGsub', '', .) %>%
           sub('_plus_KevinRoyAfiltered', '', .) %>%
           sub('_minus_KevinRoyAfiltered', '', .)) %>%
  group_by(file) %>%
  summarize(sum_pAplus_signal = sum(sum_pAplus_signal),
            sum_pAplusandminus_signal = sum(sum_pAplusandminus_signal),
            sum_pAminus_signal = sum(sum_pAminus_signal),
            sum_pAplus_positions = sum(sum_pAplus_positions),
            sum_pAplusandminus_positions = sum(sum_pAplusandminus_positions),
            sum_pAminus_positions = sum(sum_pAminus_positions)) %>%
  separate(file, c('Pap', 'strain', 'fraction', 'rapa', 'rep'), sep='_', extra='drop'))
```


```{r}
(stats_signal <- stats %>%
  dplyr::select(-contains('positions')) %>%
   dplyr::select(-Pap) %>%
  gather(signal_type, sum_signal, -strain, -fraction, -rapa, -rep))
```

```{r}
filter(stats_signal, rapa == 0)
```

```{r pAplus minus and both signal}
filter(stats_signal, rapa == 0) %>%
  ggplot(., aes(x=rep, y=sum_signal, fill=signal_type)) +
  geom_bar(stat='identity', position='dodge') +
  facet_grid(fraction ~ strain, scales='free') +
  scale_fill_brewer(palette = 'Set1') +
  theme_bw()
```

```{r pAplus vs minus signal}
filter(stats_signal, rapa == 0, signal_type != 'sum_pAplusandminus_signal') %>%
  ggplot(., aes(x=rep, y=sum_signal, fill=signal_type)) +
  geom_bar(stat='identity', position='dodge') +
  facet_grid(fraction ~ strain, scales='free') +
  scale_fill_brewer(palette = 'Set1') +
  theme_bw()
```

```{r}
(stats_signal_fractions <- filter(stats_signal, rapa == 0, signal_type != 'sum_pAplusandminus_signal') %>%
  group_by(strain,fraction,rapa,rep) %>%
  mutate(frac_signal = sum_signal/sum(sum_signal)))
```

```{r piechart pAplus vs minus signal}
ggplot(stats_signal_fractions, aes(x=factor(1), y=frac_signal, fill=signal_type)) +
  geom_bar(stat='identity') +
  facet_grid(fraction ~ strain + rep, scales='free') +
  scale_fill_brewer(palette = 'Set1') +
  coord_polar(theta='y') +
  theme_bw()
```



```{r}
(stats_pos <- stats %>%
  dplyr::select(-contains('signal')) %>%
   dplyr::select(-Pap) %>%
  gather(signal_type, positive_positions, -strain, -fraction, -rapa, -rep))
```

```{r}
filter(stats_pos, rapa == 0)
```

```{r pAplus minus and both above 0 positions}
filter(stats_pos, rapa == 0) %>%
  ggplot(., aes(x=rep, y=positive_positions, fill=signal_type)) +
  geom_bar(stat='identity', position='dodge') +
  facet_grid(fraction ~ strain) +
  scale_fill_brewer(palette = 'Set1') +
  theme_bw()
```


```{r}
(stats_pos_fractions <- filter(stats_pos, rapa == 0, signal_type != 'sum_pAplusandminus_positions') %>%
  group_by(strain,fraction,rapa,rep) %>%
  mutate(frac_positions = positive_positions/sum(positive_positions)))
```

```{r piechart pAplus vs minus positions}
ggplot(stats_pos_fractions, aes(x=factor(1), y=frac_positions, fill=signal_type)) +
  geom_bar(stat='identity') +
  facet_grid(fraction ~ strain + rep, scales='free') +
  scale_fill_brewer(palette = 'Set1') +
  coord_polar(theta='y') +
  theme_bw()
```


####some sanity check:
```{bash, eval = FALSE}
####some sanity check:

awk '$1=="chrV" && $2 == 424882' norm_noPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub.bedgraph
#chrV    424882  424883  -113.1108

awk '$1=="chrV" && $2 == 424882' norm_xPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub.bedgraph
#chrV    424882  424883  694.8

awk '$1=="chrV" && $2 == 424882' norm_xPappAminus_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub.bedgraph
#chrV    424882  424883  807.9108
--> ups this oddity since negatives are allowed !!


awk '$1=="chrV" && $2 == 424882' norm_noPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bedgraph
#chrV    424882  424883  250.01

awk '$1=="chrV" && $2 == 424882' norm_xPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bedgraph
#chrV    424882  424883  362005

awk '$1=="chrV" && $2 == 424882' norm_xPappAminus_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bedgraph
#chrV    424882  424883  361754.99
```

--> ups this oddity since negatives are allowed !!
--> otherwise seems to be OK..



```{r}
sessionInfo()
```




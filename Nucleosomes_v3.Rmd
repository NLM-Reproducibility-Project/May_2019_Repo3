---
title: 'Nucleosomes'
author: "Manfred Schmid"
output: html_document
---

`r format(Sys.time(), "%d %B, %Y")`


```{r, echo=TRUE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, 
                      fig.path=paste0('Figures_nucleosomes_v3/'), 
                      dev='pdf', echo=TRUE, warning=FALSE, message=FALSE, 
                      error=TRUE)
```


```{r load packages, echo=T, warning=F, message=F}
suppressWarnings(library(tidyverse))
suppressWarnings(library(magrittr))
suppressWarnings(library(knitr))
suppressWarnings(library(zoo))
```


## Loading bwtool matrices

For this part I used bwtool for metagene assemblies. Its simply much faster than deeptools, caveat is that it has fewer features, but enough for the part here.

a little fun to load metagene matrices generated by bwtool

### compound load functions 

#### gather a bwtool matrix result to tidy tbl

```{r}
gather_bwtool_matrix <- function(d, upstream, downstream) {
  colnames(d)[1:6] <- c('chr', 'start', 'end', 'id', 'pad', 'strand')
  colnames(d)[7:ncol(d)] <- as.character(-upstream:(downstream-1))
  d <- d[,-c(1:3,5)]
  
  print('reshaping data frame')
  d %>% 
    separate(id, c('nuc', 'id'), sep=':') %>%
    tbl_df %>%
    gather(pos, value, -id, -nuc, -strand) %>%
    mutate(pos = as.integer(pos),
           value = as.numeric(value),
           nuc = ifelse(grepl('\\*', nuc), 
                        'term', 
                        nuc)) %>% 
    filter(!is.na(value)) 
}
```

#### read file to tbl_df

```{r}
load_bwtool_nuc_matrix <- function (fname, upstream, downstream, both_strands = TRUE, cutvalues_below = 0) {
  print('loading plus strand file')
  d <- read_tsv(fname, col_names = FALSE) %>%
    gather_bwtool_matrix(upstream, downstream)
  
  minus_fname <- gsub('plus', 'minus', fname)
  print(paste('try loading minus strand file ', minus_fname))
  if( both_strands & file.exists(minus_fname) ) {
     d_minus <- read_tsv(minus_fname, col_names = FALSE) %>%
      gather_bwtool_matrix(upstream, downstream)
     
     d %<>% bind_rows(., d_minus)
  } else {
    print('--> no minus strand file found working with plus only')
  }

  print('merging and computing metagene values')
  if ( !is.na(cutvalues_below) ) {
    d %<>% filter(value > cutvalues_below)
  }
  
  d
}
```

```{r}
metagene_values <- function(d, restrict_to_genes = NULL) {
  if(!is.null(restrict_to_genes)){
    d %<>% filter(id %in% restrict_to_genes)
  }
  
  d %>% 
    group_by(nuc, pos) %>%
    summarize(events=n(),
              sum_value = sum(value),
              sum_log2_value = sum(log2(value)),
              sum_log2_valuex = sum(log2(value+1)),
              mean_log2_value = mean(log2(value)),
              mean_log2_valuex = mean(log2(value+1)))
}
```


# annotations ....

```{r}
(anno <- read_tsv('/Users/schmidm/Documents/genomewide_datasets/annotations/sacCer3/Steinmetz_annotations_sacCer3_latin.bed', col_names = c('chr', 'start', 'end', 'common_name', 'name', 'strand', 'type', 'id')))
```

```{r}
greater750_names <- anno %>%
  filter( (end-start) > 750) %$%
  name

greater1kb_names <- anno %>%
  filter( (end-start) > 1000) %$%
  name
```


## plotting functions

#### common theme for prettier and plot funs for annotated nucleosome array plots
```{r}
nuc_rel_nuc <- data.frame(
  name = c('dn1', 'dn2', 'dn3', 'dn4', 'end', 'up1', 'up2', 'up3', 'start'),
  border = c(0, 165, 330, 495, 1000, -165, -330, -495, -1000)
)

nucleosome_rel_nuc_theme <- list(scale_x_continuous(minor_breaks=NULL, breaks=nuc_rel_nuc$border),
  geom_vline(xintercept = nuc_rel_nuc$border, color='orange', linetype=2),
  geom_vline(xintercept = 0, color='black'))
```

```{r}
plus_nuc_plot <- function (df) {
  df %>%
  filter(as.numeric(nuc) < 5) %>%
  ungroup %>%
  mutate(nuc = factor(nuc, levels=c('-1','0','+1','+2','+3','+4'))) %>%
  group_by(nuc) %>%
  mutate(roll_sum_log2_value = rollmean(sum_log2_valuex, k=25, fill = NA)) %>%
  ggplot(., aes(x=pos, y=sum_log2_valuex, color=nuc)) + 
    geom_line() +
    geom_line(aes(y=roll_sum_log2_value), color='black') +
    scale_color_brewer(palette = 'BrBG', direction = -1) +
  facet_grid(nuc~.) +
  theme_bw() +
  xlab('bp to nucleosome upstream border') +
    nucleosome_rel_nuc_theme
}


plus_nuc_plot_means <- function (df) {
  df %>%
  filter(as.numeric(nuc) < 5) %>%
  ungroup %>%
  mutate(nuc = factor(nuc, levels=c('-1','0','+1','+2','+3','+4'))) %>%
  group_by(nuc) %>%
  mutate(roll_mean_log2_value = rollmean(mean_log2_value, k=25, fill = NA)) %>%
  ggplot(., aes(x=pos, y=mean_log2_value, color=nuc)) + 
    geom_line() +
    geom_line(aes(y=roll_mean_log2_value), color='black') +
    scale_color_brewer(palette = 'BrBG', direction = -1) +
  facet_grid(nuc~.) +
  theme_bw() +
  xlab('bp to nucleosome upstream border') +
    nucleosome_rel_nuc_theme
}


plus_nuc_plot_events <- function (df) {
  df %>%
  filter(as.numeric(nuc) < 5) %>%
  ungroup %>%
  mutate(nuc = factor(nuc, levels=c('-1','0','+1','+2','+3','+4'))) %>%
  group_by(nuc) %>%
  mutate(roll_mean_log2_value = rollmean(events, k=25, fill = NA)) %>%
  ggplot(., aes(x=pos, y=events, color=nuc)) + 
    geom_line() +
    geom_line(aes(y=roll_mean_log2_value), color='black') +
    scale_color_brewer(palette = 'BrBG', direction = -1) +
  facet_grid(nuc~.) +
  theme_bw() +
  xlab('bp to nucleosome upstream border') +
    nucleosome_rel_nuc_theme
}
```


```{r}
term_nuc_plot <- function (df) {
df %>%
  filter(nuc == 'term') %>%
  group_by(nuc) %>%
  mutate(roll_sum_log2_value = rollmean(sum_log2_valuex, k=10, fill = NA)) %>%
  ggplot(., aes(x=pos, y=sum_log2_valuex)) + 
  geom_line(color='gray') +
  geom_line(aes(y=roll_sum_log2_value), color='black') +
  facet_grid(nuc~.) +
  theme_bw() +
  xlab('bp to terminal nucleosome upstream border') +
    nucleosome_rel_nuc_theme
}
```



# Nucleosome Positions

We are using the data from Pugh lab publication Jiang and Pugh, 2009. This is a meta-study assembling different datasets into a common nucleoseome-positioning set.  
Processing from Additional Data 1 Excel sheet, exported to a txt file was done using in part a bash script and in part using R *processing.Rmd* in folder */Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes*

The bash script simply takes all nucleosomes and converts them to bed file
```{bash, eval = FALSE}
#extract from supplemental Additonal Data 1 Excel file from Jiang and Pugh 2009 publication
#this one has nucleosomes info from several publication and makes a common list
#saved fthe first sheed "Measured nucleosomes" as Pugh_measured_nucleosomes.txt
#nucleosomes marked with * in position are  terminal nucleosome

cat Pugh_measured_nucleosomes.txt | tr "\r" "\n" | cut -f 1-20 | head
#Name    chrom   start   end     position        peakheight      nc      occ     fuzziness       Set1    rc1     occ1    Set2    rc2     occ2    Set3    rc3     occ3    Set4    rc4
#N1:192  chr01   119     265             1,11    3       80,5    41      151     10      89                              192     109     72
#N1:382  chr01   309     455             3,61    5       71      21,916  376     260     100     427     7       100     372     50      13
#N1:630  chr01   557     703             4,31    5       62      10,756  622     359     100     647     2       79      636     44      7
#N1:872  chr01   799     945             3,81    5       65      15,643                          864     11      100     845     65      28      880     5
#N1:1033 chr01   960     1106            3,44    4       52,5    11,325  1022    74      100                             1034    42      5
#N1:1191 chr01   1118    1264            2,99    3       100     1,732   1190    17      100
#N1:1340 chr01   1267    1413            2,05    3       50      24,007  1340    74      100                             1380    16      0
#N1:1585 chr01   1512    1658    "+5*:YAL068C; " 3,83    4       50      5,916   1594    67      100                             1582    22      0
#N1:1902 chr01   1829    1975    "+3:YAL068C; "  2,67    4       50      35,968  1893    325     100                             1972    8       0

cat Pugh_measured_nucleosomes.txt | tr "\r" "\n" | cut -f 2 | uniq -c

cat Pugh_measured_nucleosomes.txt | tr "\r" "\n" | cut -f 2-5 | sed s/"; "/";"/g | head

cat Pugh_measured_nucleosomes.txt | tr "\r" "\n" | cut -f 2-6 | sed 1d | sed s/"; "/";"/g | awk '{OFS="\t"}{$2-=1;print $0}'> Pugh_measured_nucleosomes_roman0.bed
#I strongly assume that the coordinates are NOT 0-based (its called start position and end position), so I convert to bed 0-based half-open...

python ~/ms_tools/convert_chr_names2.py -f roman0 -t latin Pugh_measured_nucleosomes_roman0.bed > Pugh_measured_nucleosomes.bed

head -20 Pugh_measured_nucleosomes.bed
```


# nucleosome density rel TSS and TES

First check out how those data map relative Steinmetz annotations. From all we know that should be some very sharp positioning, its more like a sanity check.  

#### make a nucleosome center track
```{bash, eval = FALSE}
#nucleosome coverage in various ways
cat Pugh_measured_nucleosomes.bed | \
awk '{OFS="\t"}{
  if($4 ~ /:/){
    val=$5
  }else{
    val=$4
  };
  sub(",",".",val);
  print $1"\t"$2"\t"$3"\t"val
}' > Pugh_measured_nucleosomes_coverage.bedGraph

/Users/schmidm/ms_tools/bedGraphToBigWig Pugh_measured_nucleosomes_coverage.bedGraph /Users/schmidm/Documents/genomewide_datasets/annotations/sacCer3/sacCer3_genome_latin.info Pugh_measured_nucleosomes_coverage.bw

# !! fails because chromosomes a few nt too long
# sacCer1 and sacCer2 have same problem !?
# perhaps caused by calling nucleosomes procedure ... ie extend to defined width 146 ?? ...
awk '{print $3-$2}' Pugh_measured_nucleosomes_coverage.bedGraph | uniq -c
#61110 147


## in any case, it should be compatible with sacCer3 and hence I simply do
bedtools slop -i Pugh_measured_nucleosomes_coverage.bedGraph -g /Users/schmidm/Documents/genomewide_datasets/annotations/sacCer3/sacCer3_genome_latin.info -b 0 > Pugh_measured_nucleosomes_coverage_trimmed.bedGraph


diff Pugh_measured_nucleosomes_coverage.bedGraph Pugh_measured_nucleosomes_coverage_trimmed.bedGraph
#1183c1183
#< chrI  230082  230229  1.99
#---
#> chrI  230082  230218  1.99 ##removing 11bp on right
#5317c5317
#< chrII 813075  813222  1.00
#---
#> chrII 813075  813184  1.00 ##removing 38bp on right
#6917c6917
#< chrIII        316488  316635  2.02
#---
#> chrIII        316488  316620  2.02 ##removing 25bp on right
#18957c18957
#< chrVI 270089  270236  1.02
#---
#> chrVI 270089  270161  1.02  ##removing 75bp on right
#29596c29596
#< chrIX 439771  439918  2.71
#---
#> chrIX 439771  439888  2.71  ##removing 30bp on right
#46744c46744
#< chrXIII       924287  924434  2.08
#---
#> chrXIII       924287  924431  2.08   ##removing 3bp on right
#50751c50751
#< chrXIV        784187  784334  1.06
#---
#> chrXIV        784187  784333  1.06 ##removing 1bp on right

### overall very little trimming done


### NUCLEOSOME CENTERS
##note all nucleosomes are made 146bp wide, this script sets the center at the dyad position

awk '{half=($3-$2-1)/2; $2+=half;$3-=half;print $0}' Pugh_measured_nucleosomes_coverage_trimmed.bedGraph > \
Pugh_measured_nucleosomes_center_coverage.bedGraph

/Users/schmidm/ms_tools/bedGraphToBigWig \
Pugh_measured_nucleosomes_center_coverage.bedGraph \
/Users/schmidm/Documents/genomewide_datasets/annotations/sacCer3/sacCer3_genome_latin.info \
Pugh_measured_nucleosomes_center.bw

```


#### nucleosomes metagene profiles
```{bash, eval = FALSE}
cd /Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes

bed="/Users/schmidm/Documents/genomewide_datasets/annotations/sacCer3/Steinmetz_annotations_sacCer3_latin_ORFs.bed"

awk '{OFS="\t"}{$4=$7":"$8":"$5":"$4;$5="0";print $0}' $bed | cut -f 1-6 > ${bed/.bed/_correctformat.bed}

bwtool matrix 1000:1000 -starts -keep-bed ${bed/.bed/_correctformat.bed} Pugh_measured_nucleosomes_center.bw bwtool_nuc_center_rel_ORF_TSS.txt

bwtool matrix 1000:1000 -ends -keep-bed ${bed/.bed/_correctformat.bed} Pugh_measured_nucleosomes_center.bw bwtool_nuc_center_rel_ORF_TES.txt

```


```{r, eval = FALSE}
nuc_rel_tss <- load_bwtool_nuc_matrix('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/bwtool_nuc_center_rel_ORF_TSS.txt', 1000, 1000, both_strands = FALSE)


nuc_rel_tes <- load_bwtool_nuc_matrix('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/bwtool_nuc_center_rel_ORF_TES.txt', 1000, 1000, both_strands = FALSE)

save(nuc_rel_tss, file='data/nucleosome_centers_rel_TSS.RData')
save(nuc_rel_tes, file='data/nucleosome_centers_rel_TES.RData')
```

```{r, eval = TRUE}
load('data/nucleosome_centers_rel_TSS.RData', verbose=TRUE)
load('data/nucleosome_centers_rel_TES.RData', verbose=TRUE)
```


make common theme for prettier and annotated TSS plots
```{r}
nuc_rel_TSS <- data.frame(
  name = c('+1', '+2', '+3', '+4', '+5', '+6', 'up1', 'up2', 'up3'),
  center = c(50, 215, 380, 545, 710, 875, -225, -390, -555)
  ) %>%
  mutate(end = center + 74,
         start = center - 74)

nucleosome_rel_tss_theme <- list(scale_x_continuous(minor_breaks=NULL, breaks=nuc_rel_TSS$center),
                         scale_y_continuous(breaks=NULL),
  geom_vline(xintercept = nuc_rel_TSS$center, color='orange', linetype=2),
  geom_vline(xintercept = 0, color='black'), 
  geom_rect(data=nuc_rel_TSS,
            aes(xmin = start, xmax = end,
                ymin=-5, ymax=0), fill = 'gray',
            inherit.aes = FALSE),
  geom_text(data=nuc_rel_TSS,
            aes(x=center, y=-2.5, label=name),
            inherit.aes = FALSE))
```

```{r nucleosomes around ORF-T TSS}
nuc_rel_tss %>%
  ggplot(., aes(x=pos, y=sum_log2_value)) + 
  geom_line() +
  xlab('bp tp TSS') +
  ylab('nucleosome centers\n( sum of log2(peak height) )') + 
  theme_bw() +
  nucleosome_rel_tss_theme
```

--> extrememly well-defined phasing (165 nt periodicity) of nucleosome centers with respect to TSS, which lies inside +1 nucleosome.


```{r nucleosomes around ORF-T TES}
nuc_rel_tes %>%
  mutate(roll_sum_log2_value = rollmean(sum_log2_value, k=20, fill = NA)) %>%
  ggplot(., aes(x=pos, y=roll_sum_log2_value)) + 
  geom_line(color='black') +
  theme_bw() +
  xlab('bp to TES') +
  ylab('nucleosome centers\n( sum of log2(peak height) )') +
    nucleosome_rel_tss_theme[c(1:4)]
```

--> phasing and a nucleosome-depleted region is also present at the TES but the strength of the depletion and positioning of the nucleosomes around is much(!) less pronounced compared to the TSS.  

--> strikingly the TES phases with pretty much some distance as TSS ie TSS are often identical to TES from adjacent gene !?



# 3'seq data rel nucleosomes

#### create bwtool matrices
```{bash, eval = FALSE}
#!/usr/bin/env bash

cd ~/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/

#### STRANDED VERSION

bed_plus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_plus.bed"
bed_minus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_minus.bed"

cd ~/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/

###xPap IP
bw="norm_xPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


###noPap IP
bw="norm_noPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


###pAminus IP
bw="norm_xPappAminus_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


###pAminus_masked IP
cd only_pAminus_positions
bw="norm_xPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub_wo_noPaP_0rapa_sites.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw ../bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus ../bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


### INPUT

###xPap input
bw="norm_xPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


###noPap input
bw="norm_noPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


###pAminus input
bw="norm_xPappAminus_Mex67AA_input_0_1_plus_KevinRoyAfiltered.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}


###pAminus_masked input
cd only_pAminus_positions
bw="norm_xPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered_wo_noPaP_0rapa_sites.bw"
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus $bw ../bwtool_out/${bw/.bw/_all_unique_plus_nuc_mat.txt}

bw_minus=${bw/plus/minus}
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus $bw_minus ../bwtool_out/${bw_minus/.bw/_all_unique_minus_nuc_mat.txt}

```


## 3seq IPs

### IP pAplus and minus

```{r}
mat_fname <- 'norm_xPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```

```{r, eval = FALSE}
agg_xPap_ip_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_xPap_ip_3seq %<>%
  distinct(nuc,id,strand,pos,value)

save(agg_xPap_ip_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_xPap_ip_3seq_meta <- metagene_values(agg_xPap_ip_3seq, restrict_to_genes = greater750_names)
```

```{r ip pAplusandminus plus nucleosomes}
plus_nuc_plot(agg_xPap_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAplusandminus mean plus nucleosomes}
plus_nuc_plot_means(agg_xPap_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAplusandminus events plus nucleosomes}
plus_nuc_plot_events(agg_xPap_ip_3seq_meta) +
  ggtitle(sample_name)
```


```{r ip pAplusandminus terminal nucleosome}
term_nuc_plot(agg_xPap_ip_3seq_meta) +
  ggtitle(sample_name)
```



### IP pAplus

```{r}
mat_fname <- 'norm_noPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```


```{r, eval = FALSE}
agg_noPap_ip_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_noPap_ip_3seq %<>% distinct(nuc,id,strand,pos,value) 

save(agg_noPap_ip_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_noPap_ip_3seq_meta <- metagene_values(agg_noPap_ip_3seq, restrict_to_genes = greater750_names)
```


```{r ip pAplus plus nucleosomes}
plus_nuc_plot(agg_noPap_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAplus mean plus nucleosomes }
plus_nuc_plot_means(agg_noPap_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAplus events plus nucleosomes }
plus_nuc_plot_events(agg_noPap_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAplus terminal nucleosome}
term_nuc_plot(agg_noPap_ip_3seq_meta) +
  ggtitle(sample_name)
```



### IP pAminus

```{r}
mat_fname <- 'norm_xPappAminus_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```


```{r, eval = FALSE}
agg_xPappAminus_ip_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_xPappAminus_ip_3seq %<>% distinct(nuc,id,strand,pos,value)

save(agg_xPappAminus_ip_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_xPappAminus_ip_3seq_meta <- metagene_values(agg_xPappAminus_ip_3seq, restrict_to_genes = greater750_names)
```

```{r ip pAminus plus nucleosomes}
plus_nuc_plot(agg_xPappAminus_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAminus mean plus nucleosomes}
plus_nuc_plot_means(agg_xPappAminus_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAminus events plus nucleosomes}
plus_nuc_plot_events(agg_xPappAminus_ip_3seq_meta) +
  ggtitle(sample_name)
```

```{r ip pAminus terminal nucleosome}
term_nuc_plot(agg_xPappAminus_ip_3seq_meta) +
  ggtitle(sample_name)
```



## 3seq inputs

### input pAplus

```{r}
mat_fname <- 'norm_noPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```


```{r, eval = FALSE}
agg_noPap_input_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_noPap_input_3seq %<>% distinct(nuc,id,strand,pos,value)

save(agg_noPap_input_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_noPap_input_3seq_meta <- metagene_values(agg_noPap_input_3seq, restrict_to_genes = greater750_names)
```


```{r input pAplus plus nucleosomes}
plus_nuc_plot(agg_noPap_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAplus means plus nucleosomes}
plus_nuc_plot_means(agg_noPap_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAplus events plus nucleosomes}
plus_nuc_plot_events(agg_noPap_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAplus terminal nucleosome}
term_nuc_plot(agg_noPap_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```




### input pAminus

```{r}
mat_fname <- 'norm_xPappAminus_Mex67AA_input_0_1_plus_KevinRoyAfiltered_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```


```{r, eval = FALSE}
agg_xPappAminus_input_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_xPappAminus_input_3seq %<>%
  distinct(nuc,id,strand,pos,value)

save(agg_xPappAminus_input_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_xPappAminus_input_3seq_meta <- metagene_values(agg_xPappAminus_input_3seq, restrict_to_genes = greater750_names)
```


```{r input pAminus plus nucleosomes}
plus_nuc_plot(agg_xPappAminus_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAminus means plus nucleosomes}
plus_nuc_plot_means(agg_xPappAminus_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAminus events plus nucleosomes}
plus_nuc_plot_events(agg_xPappAminus_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```
```{r input pAminus terminal nucleosome}
term_nuc_plot(agg_xPappAminus_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```


## 3'seq pAmasked input samples

### input pAminus using mask

```{r}
mat_fname <- 'norm_xPap_Mex67AA_input_0_1_plus_KevinRoyAfiltered_wo_noPaP_0rapa_sites_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```


```{r, eval = FALSE}
agg_xPap_masked_input_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_xPap_masked_input_3seq %<>%
  distinct(nuc,id,strand,pos,value)

save(agg_xPap_masked_input_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_xPap_masked_input_3seq_meta <- metagene_values(agg_xPap_masked_input_3seq, restrict_to_genes = greater750_names)
```


```{r input pAminus masked plus nucleosomes}
plus_nuc_plot(agg_xPap_masked_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAminus masked means plus nucleosomes}
plus_nuc_plot_means(agg_xPap_masked_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAminus masked events plus nucleosomes}
plus_nuc_plot_events(agg_xPap_masked_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r input pAminus masked terminal nucleosome}
term_nuc_plot(agg_xPap_masked_input_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```



### IP pAminus using mask

```{r}
mat_fname <- 'norm_xPap_Mex67AA_ip_0_1_plus_KevinRoyAfiltered_BGsub_wo_noPaP_0rapa_sites_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_KevinRoyAfiltered', '', mat_fname) %>%
  sub('_all_unique_plus_nuc_mat.txt', '', .)

RData_filename <- paste0('data/', sample_name, '_rel_nucleosome_start_bwtool.RData')
```


```{r, eval = FALSE}
agg_xPap_masked_ip_3seq <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/Results/Lexogen_RNAseq_2/STAR_bw/norm_and_pA_filtered_bw/bwtool_out/', mat_fname), 1000, 1000, both_strands = TRUE)

agg_xPap_masked_ip_3seq %<>%
  distinct(nuc,id,strand,pos,value) 

save(agg_xPap_masked_ip_3seq, file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
agg_xPap_masked_ip_3seq_meta <- metagene_values(agg_xPap_masked_ip_3seq, restrict_to_genes = greater750_names)
```


```{r ip pAminus masked plus nucleosomes}
plus_nuc_plot(agg_xPap_masked_ip_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r ip pAminus masked means plus nucleosomes}
plus_nuc_plot_means(agg_xPap_masked_ip_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r ip pAminus masked events plus nucleosomes}
plus_nuc_plot_events(agg_xPap_masked_ip_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r ip pAminus masked terminal nucleosome}
term_nuc_plot(agg_xPap_masked_ip_3seq_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```


# CRAC data rel nucleosomes
```{bash, eval = FALSE}
#!/usr/bin/env bash

cd /Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Tollervey_RNAP_CRAC

bed_plus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_plus.bed"
bed_minus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_minus.bed"

##CRAC RPO21
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus GSM1706520_Rpo21_nabFT_plus.bw GSM1706520_Rpo21_nabFT_all_unique_plus_nuc_mat.txt

bwtool matrix 1000:1000 -starts -keep-bed $bed_minus GSM1706520_Rpo21_nabFT_minus.bw GSM1706520_Rpo21_nabFT_all_unique_minus_nuc_mat.txt
```


```{r}
mat_fname <- 'GSM1706520_Rpo21_nabFT_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_plus_nuc_mat.txt', '', mat_fname) 

RData_filename <- paste0('data/', sample_name, '_CRAC_rel_nucleosome_start_bwtool.RData')
```

```{r, eval = FALSE}
crac_nucs <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Tollervey_RNAP_CRAC/', mat_fname), 1000, 1000, both_strands = TRUE)

crac_nucs %>%
  distinct(nuc,id,strand,pos,value) %>%
  save(., file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```


```{r}
crac_nucs_meta <- metagene_values(crac_nucs, restrict_to_genes = greater750_names)
```

```{r CRAC Milligan plus nucleosomes}
plus_nuc_plot(crac_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r CRAC Milligan means plus nucleosomes}
plus_nuc_plot_means(crac_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r CRAC Milligan events plus nucleosomes}
plus_nuc_plot_events(crac_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r CRAC Milligan terminal nucleosome}
term_nuc_plot(crac_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```




# NETseq data rel nucleosomes
```{bash, eval = FALSE}
#!/usr/bin/env bash

cd /Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Churchman_NETseq

bed_plus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_plus.bed"
bed_minus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_minus.bed"


#WT
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus GSM617027_WT_NC_plus_sacCer3.bw GSM617027_WT_NC_all_unique_plus_nuc_mat.txt
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus GSM617027_WT_NC_minus_sacCer3.bw GSM617027_WT_NC_all_unique_minus_nuc_mat.txt

#DST1∆
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus GSM617030_DST1D_plus_sacCer3.bw GSM617030_DST1D_all_unique_plus_nuc_mat.txt
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus GSM617030_DST1D_minus_sacCer3.bw GSM617030_DST1D_all_unique_minus_nuc_mat.txt
```


#### NETseq wt
```{r}
mat_fname <- 'GSM617027_WT_NC_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_all_unique_plus_nuc_mat.txt', '', mat_fname) 

RData_filename <- paste0('data/', sample_name, '_NETseq_WT_rel_nucleosome_start_bwtool.RData')
```

```{r, eval = FALSE}
NETseq_wt_nucs <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Churchman_NETseq/', mat_fname), 1000, 1000, both_strands = TRUE)

NETseq_wt_nucs %>%
  distinct(nuc,id,strand,pos,value) %>%
  save(., file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
NETseq_wt_nucs_meta <- metagene_values(NETseq_wt_nucs, restrict_to_genes = greater750_names)
```

```{r NETseq wt plus nucleosomes}
plus_nuc_plot(NETseq_wt_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r NETseq wt means plus nucleosomes}
plus_nuc_plot_means(NETseq_wt_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r NETseq wt events plus nucleosomes}
plus_nuc_plot_events(NETseq_wt_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r NETseq wt terminal nucleosome}
term_nuc_plot(NETseq_wt_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```



#### NETseq dst1∆
```{r}
mat_fname <- 'GSM617030_DST1D_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_all_unique_plus_nuc_mat.txt', '', mat_fname) 

RData_filename <- paste0('data/', sample_name, '_NETseq_dst1_rel_nucleosome_start_bwtool.RData')
```

```{r, eval = FALSE}
NETseq_dst1_nucs <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Churchman_NETseq/', mat_fname), 1000, 1000, both_strands = TRUE)

NETseq_dst1_nucs %>%
  distinct(nuc,id,strand,pos,value) %>%
  save(., file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
NETseq_dst1_nucs_meta <- metagene_values(NETseq_dst1_nucs, restrict_to_genes = greater750_names)
```


```{r NETseq dst1 plus nucleosomes}
plus_nuc_plot(NETseq_dst1_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r NETseq dst1 terminal nucleosome}
term_nuc_plot(NETseq_dst1_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```


## Rpb3 ChIPseq data rel nucleosomes
```{bash, eval = FALSE}
cd /Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Henikoff_Rpb3FLAG_ChIPseq

bed_plus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_plus.bed"
bed_minus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_minus.bed"

#WT
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus GSM2551210_WT_A_140.bw GSM2551210_WT_all_unique_plus_nuc_mat.txt
bwtool matrix 1000:1000 -starts -keep-bed $bed_minus GSM2551210_WT_A_140.bw GSM2551210_WT_all_unique_minus_nuc_mat.txt
```


#### Rpb3 ChIPseq
```{r}
mat_fname <- 'GSM2551210_WT_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_all_unique_plus_nuc_mat.txt', '', mat_fname) 

RData_filename <- paste0('data/', sample_name, '_Rpb3_ChIPseq_rel_nucleosome_start_bwtool.RData')
```

```{r, eval = FALSE}
Rpb3_ChIPseq_nucs <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Henikoff_Rpb3FLAG_ChIPseq/', mat_fname), 1000, 1000, both_strands = TRUE)

Rpb3_ChIPseq_nucs %>%
  distinct(nuc,id,strand,pos,value) %>%
  save(., file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
Rpb3_ChIPseq_nucs_meta <- metagene_values(Rpb3_ChIPseq_nucs, restrict_to_genes = greater750_names)
```


```{r Rpb3 ChIPseq plus nucleosomes}
plus_nuc_plot(Rpb3_ChIPseq_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r Rpb3 ChIPseq terminal nucleosome}
term_nuc_plot(Rpb3_ChIPseq_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```



```{r}
sessionInfo()
```



## Rpb3 ChIP on chip rel nucleosomes
```{bash, eval = FALSE}
#!/usr/bin/env bash
cd /Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Cramer_ChIPchip

bed_plus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_plus.bed"
bed_minus="/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Pugh_nucleosomes/Pugh_measured_nucleosomes_plus_unique_with_strand_minus.bed"

#WT
bwtool matrix 1000:1000 -starts -keep-bed $bed_plus Cramer_E_TABM_1033_Rpb3_InputAndMockNormalized_sacCer3.bw Cramer_E_TABM_1033_Rpb3_all_unique_plus_nuc_mat.txt

bwtool matrix 1000:1000 -starts -keep-bed $bed_minus Cramer_E_TABM_1033_Rpb3_InputAndMockNormalized_sacCer3.bw Cramer_E_TABM_1033_Rpb3_all_unique_minus_nuc_mat.txt
```


```{r}
mat_fname <- 'Cramer_E_TABM_1033_Rpb3_all_unique_plus_nuc_mat.txt'

sample_name <- sub('_all_unique_plus_nuc_mat.txt', '', mat_fname) 

RData_filename <- paste0('data/', sample_name, '_ChIPonchip_rel_nucleosome_start_bwtool.RData')
```

```{r, eval = FALSE}
Rpb3_ChIPonchip_nucs <- load_bwtool_nuc_matrix(paste0('/Users/schmidm/Documents/genomewide_datasets/ChIP_CLiP_yeast/Cramer_ChIPchip/', mat_fname), 1000, 1000, both_strands = TRUE)

Rpb3_ChIPonchip_nucs %>%
  distinct(nuc,id,strand,pos,value) %>%
  save(., file=RData_filename)
```


```{r, eval = TRUE}
load(RData_filename, verbose=TRUE)
```

```{r}
Rpb3_ChIPonchip_nucs_meta <- metagene_values(Rpb3_ChIPonchip_nucs, restrict_to_genes = greater750_names)
```

```{r Rpb3 ChIPonchip plus nucleosomes}
plus_nuc_plot(Rpb3_ChIPonchip_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```

```{r Rpb3 ChIPonchip terminal nucleosome}
term_nuc_plot(Rpb3_ChIPonchip_nucs_meta) +
  ggtitle(sample_name) +
  xlab('bp to nucleosome border')
```



```{r}
sessionInfo()
```
